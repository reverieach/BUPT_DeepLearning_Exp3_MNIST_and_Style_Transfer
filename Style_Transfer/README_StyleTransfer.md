# 实验三（下）：图像风格迁移 (Image Style Transfer) 操作指南

本指南涵盖实验三第二部分的所有任务，包括模型训练、进度可视化及自定义风格迁移。

## 1. 实验简介
**目标**：
1.  训练 AdaIN 模型 (10,000 次迭代) 并可视化不同阶段(10%, 50%, 80%, 100%)的效果。
2.  完成“北邮景点合照迁移”任务。
3.  完成“基于学号的 Alpha 混合”任务。

---

## 2. 准备工作 (Prerequisites)

### 2.1 代码库与模型
确保 `style_transfer` 目录下有 `pytorch-AdaIN` 文件夹。
-   **预训练模型** (仅用于直接推理，若训练则会生成新模型): 
    下载 `decoder.pth`, `vgg_normalised.pth` 放入 `pytorch-AdaIN/models/`。

### 2.2 数据集 (仅“训练模式”需要)
若要完成 **任务 (1) & (2)** (训练模型)，你需要准备以下数据集：
-   **MS-COCO** (作为内容图): 
    -   **推荐下载**: **2017 Train images** (118K images, ~18GB).
    -   **小体积替代方案**: **2017 Val images** (5K images, ~1GB). 对本次实验来说，5000 张图跑 10000 次迭代完全足够。
    -   只需要图片，不需要标注文件。
-   **WikiArt** (作为风格图):
    -   **下载地址**: [Kaggle: Best Artworks of All Time](https://www.kaggle.com/datasets/ikarus777/best-artworks-of-all-time) (推荐，包含 resize 版) 或 [Kaggle: WikiArt](https://www.kaggle.com/datasets/rteja1113/wikiart-dataset)
    -   只需要其中的图片文件夹 (通常是 `resized` 或 `images` 文件夹)，解压后指向该文件夹。
建议将 ಅವು们解压到 `datasets` 目录，例如：
-   `d:\study\深度学习\实验三\datasets\coco\val2017`
-   `d:\study\深度学习\实验三\datasets\wikiart`
*(若无数据集，只能运行推理模式)*

### 2.3 图片素材 (用于自定义任务)
1.  **合照 1 & 2**: `bupt1.jpg`, `bupt2.jpg` (你自己与北邮景点的合照)
2.  **风格图 A**: `style.jpg` (用于任务 3)
3.  **风格图 B**: `style2.jpg` (必须不同于风格图 A，用于任务 4)

---

## 3. 运行实验 (Run)

运行交互式脚本，选择相应模式：
```bash
python run_lab.py
```
脚本提供三种模式：
1.  **Full Experiment**: 包含训练、进度报告生成、以及自定义任务。
2.  **Inference Only**: 仅运行自定义任务 (Task 3 & 4)，适合没有数据集的情况。
3.  **Training Only**: 仅运行训练和进度报告。

### 任务详解

#### 任务 (1) & (2): 模型训练与可视化
-   脚本会调用 `train.py` 训练 10,000 次，每 1,000 次保存一次模型。
-   训练结束后，会自动生成 **10%, 50%, 80%, 100%** 进度的效果图。
-   结果保存在当前目录下，文件名为 `training_progress_10%.png` 等。
-   **Tensorboard**: 训练过程中，可在终端运行 `tensorboard --logdir pytorch-AdaIN/logs` 查看 Loss 曲线。

#### 任务 (3): 北邮景点风格迁移
-   根据提示输入你的两张 **“人与景点合照”** 路径。
-   脚本将生成迁移后的图片。

#### 任务 (4): Alpha 混合
-   脚本会要求输入 **第二种** 不同的风格图片。
-   输入 **学号**，脚本自动判断奇偶性并应用对应的 $$ \alpha $$ 值 ([0.3, 0.6, 0.9] 或 [0.2, 0.5, 0.8])。
-   生成混合强度的对比图。

---

## 4. 常见问题 (FAQ)

**Q: 训练太慢怎么办？**
A: 风格迁移训练通常需要 GPU。如果没有 GPU，建议只跑几步测试，或者直接使用预训练模型完成任务 3 & 4 (选择模式 2)。

**Q: 如何打开 TensorBoard 查看训练过程？**
A: 在终端中运行以下命令：
```bash
tensorboard --logdir pytorch-AdaIN/logs
```
然后打开浏览器访问显示的链接（通常是 `http://localhost:6006`）。

**Q: 对上传的图片分辨率有要求吗？**
A: 
-   **没有严格限制**，代码会自动调整大小。
-   **默认处理**：代码会将图片的**短边缩放到 512 像素**，并保持长宽比（不裁剪）。
-   **建议**：
    -   为了获得最佳效果，建议上传分辨率在 **500x500 到 1000x1000** 之间的图片。
    -   如果图片太小（如 <256px），生成的图片可能会模糊。
    -   如果图片太大（如 >2000px），会被自动缩小，不会影响运行，但细节可能会丢失。

**Q: 我可以使用 COCO API (pycocotools) 吗？**
A: 
-   **不需要/不建议**。目前的 `train.py` 使用的是 `FlatFolderDataset`，它只需要一个**包含图片的文件夹**路径。
-   **不需要 JSON 标签**：风格迁移是无监督的，不需要 COCO 的标注信息。
-   **如何操作**：如果你已经下载了 COCO 数据集，直接将 `--content_dir` 指向其中的图片文件夹（例如 `train2017` 或 `val2017` 文件夹）即可，不要指向包含 json 的根目录。

**Q: 这样训练出来的模型能“识别”出不同的艺术风格吗？**
A: 
-   **严格来说，不能**：这是一个**生成的（Generative）**模型，而不是分类（Classification）模型。它不会告诉你“这张图是梵高画的”或者“这是立体主义”。
-   **但是，它能“区分”并“应用”任意风格**：
    -   AdaIN 的核心优势是 **Arbitrary Style Transfer（任意风格迁移）**。
    -   这意味着模型学习的是**“如何提取风格特征”**（即特征图的均值和方差），而不是记住具体的风格。
    -   因此，即使你给它一张训练时从未见过的涂鸦或现代艺术图，它也能提取出那张图的笔触、纹理和色彩，并迁移到你的照片上。它具有很强的**泛化能力**。

**Q: `Loss` 不下降？**
A: 检查 Tensorboard 曲线。AdaIN 收敛较快，前几百次迭代 Loss 应该能明显下降。

**Q: 找不到 `cornell.jpg`？**
A: 这是仓库自带的测试图，应该在 `pytorch-AdaIN/input/content/` 下。如果缺失，请重新 clone 仓库。
